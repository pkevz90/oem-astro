<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=1.0, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div>
        <input type="file" onchange="loadFileAsText(event)" accept=".e,.tle">
        <span id="e-date" style="visibility: hidden;">Epoch Time <input type="datetime-local"></span>
    </div>
    <div id="parameters">
    <div>Range <input type="number" style="width: 8ch;"> m</div>
    <div>CATS <input type="number" style="width: 6ch;"><sup>o</sup></div>
    </div>
    <div><button onclick="exportFile()">Export With Error</button></div>
    <script>
        let windowOptions = {
            p_error_ground: 5000,
            v_error_ground: 2,
            p_error: null,
            v_error: null,
            inputData: null,
            epochDate: null
        }
        function stringToCoes(oldTle) {
            oldTle = oldTle.split(/\n/);
            oldTle[0] = oldTle[0].split(/ +/);
            oldTle[1] = oldTle[1].split(/ +/);
            return {
                Number: oldTle[1][1],
                epoch: oldTle[0][2],
                inc: Number(oldTle[1][2]),
                raan: Number(oldTle[1][3]),
                arg: Number(oldTle[1][5]),
                mA: Number(oldTle[1][6]),
                ecc: Number('0.' + oldTle[1][4]),
                mm: oldTle[1][7],
            }
        }
        function buttonClick() {
            let oldTle = document.getElementById('main-area').value;
            document.getElementById('main-area').style.color = "#000"
            try {a
                tle = stringToCoes(oldTle);
            }
            catch (e) {
                console.log(e);
                document.getElementById('main-area').style.color = "#ff0000"
                document.getElementById('result-area').value = '';
                return;
            }
            let error = Number(document.getElementById('uncertainty').value);
            console.log(error);
            error = Math.sqrt(error * error / 5);
            tle.ecc = (tle.ecc + error / 42164 * normalRandom()).toFixed(7).split('.')[1];
            tle.inc = (tle.inc + (error / 42164) * 180 / Math.PI * normalRandom()).toFixed(4);
            tle.raan = (tle.raan + (error / 42164) * 180 / Math.PI * normalRandom()).toFixed(4);
            tle.arg = (tle.arg + (error / 42164) * 180 / Math.PI * normalRandom()).toFixed(4);
            tle.mA = (tle.mA + (error / 42164) * 180 / Math.PI * normalRandom()).toFixed(4);
            while (tle.inc.split('.')[0].length < 3) {
                tle.inc = '0' + tle.inc;
            }
            while (tle.raan.split('.')[0].length < 3) {
                tle.raan = '0' + tle.raan;
            }
            while (tle.arg.split('.')[0].length < 3) {
                tle.arg = '0' + tle.arg;
            }
            while (tle.mA.split('.')[0].length < 3) {
                tle.mA = '0' + tle.mA;
            }
            let outString = `1 ${tle.Number}U          ${tle.epoch}  .00000000  00000-0  00000-0 0 00007\n2 ${tle.Number} ${tle.inc} ${tle.raan} ${tle.ecc} ${tle.arg} ${tle.mA} ${tle.mm}`
            document.getElementById('result-area').value = outString;
            document.getElementById('result-area').select();
            document.execCommand("copy");
        }

        function normalRandom()
        {
            var val, u, v, s, mul;
            spareRandom = null;
            if(spareRandom !== null)
            {
                val = spareRandom;
                spareRandom = null;
            }
            else
            {
                do
                {
                    u = Math.random()*2-1;
                    v = Math.random()*2-1;

                    s = u*u+v*v;
                } while(s === 0 || s >= 1);

                mul = Math.sqrt(-2 * Math.log(s) / s);

                val = u * mul;
                spareRandom = v * mul;
            }
            
            return val;
        }
        function loadFileAsText(event) {
            fileToLoad = event.path[0].files[0];
            let ext = fileToLoad.name.split('.')[1];
            let fileReader = new FileReader();
            fileReader.onload = function (fileLoadedEvent) {
                let text = fileLoadedEvent.target.result;
                text = text.split('EphemerisTimePosVel');
                text[1] = text[1].split(/\n+/);
                text[0] = text[0] + 'EphemerisTimePosVel' + text[1][0];
                text[1].shift();
                windowOptions.inputData = text;
                let date = text[0].substr(385);
                windowOptions.epochDate = new Date(date.substr(0,date.search('UTCG') - 1));
            };
            if (ext === 'e') {
                document.getElementById('e-date').style.visibility = 'visible';
            }
            fileReader.readAsText(fileToLoad, "UTF-8");
        }
    
        function exportFile() {
            let desDate = new Date(document.getElementById('e-date').getElementsByTagName('input')[0].value);
            if (desDate == 'Invalid Date') return;
            let timeDiff = desDate - windowOptions.epochDate;
            timeDiff /= 1000;
            let timeLine = windowOptions.inputData[1].findIndex(line => {
                return Number(line.split(/ +/)[1]) >= timeDiff;
            });
            windowOptions.inputData[1] = windowOptions.inputData[1].slice(timeLine,timeLine+1);
            let state = windowOptions.inputData[1][0].split(/ +/);
            // Get error sources
            let err_inputs = document.getElementById('parameters').getElementsByTagName('input');
            let r_input = Number(err_inputs[0].value);
            let cats_input = Number(err_inputs[1].value);
            let total_error = r_input * 0.05*(0.056234132519034905 *Math.pow(Math.abs(30-cats_input), 1.25)+0.5);
            alert(`Total error STD of ${total_error}`)
            let p_error = Math.sqrt(Math.pow(total_error, 2) / 3);
            let v_error = Math.sqrt(Math.pow(total_error / 2000, 2) / 3);
            state[2] = Number(state[2]) + normalRandom() * p_error;
            state[3] = Number(state[3]) + normalRandom() * p_error;
            state[4] = Number(state[4]) + normalRandom() * p_error;
            state[5] = Number(state[5]) + normalRandom() * v_error;
            state[6] = Number(state[6]) + normalRandom() * v_error;
            state[7] = Number(state[7]) + normalRandom() * v_error;
            windowOptions.inputData[1] = `${state[1]} ${state[2]} ${state[3]} ${state[4]} ${state[5]} ${state[6]} ${state[7]}`; 
            let outText = windowOptions.inputData[0] + '\n\n' + windowOptions.inputData[1] + '\n\n\n' + 'END Ephemeris';
            downloadFile('corrupted.e', outText);
        }

        function downloadFile(filename, text) {
            var pom = document.createElement('a');
            pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            pom.setAttribute('download', filename);

            if (document.createEvent) {
                var event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
            } else {
                pom.click();
            }
        }
    </script>
</body>
</html>